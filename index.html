<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FreePro - Calculadoras Profissionais</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --secondary: #22c55e;
      --secondary-dark: #16a34a;
      --accent: #8b5cf6;
      --warning: #f59e0b;
      --danger: #dc2626;
      --success: #22c55e;
      --bg-primary: #111827;
      --bg-secondary: #1f2937;
      --bg-card: #374151;
      --text-primary: #f9fafb;
      --text-secondary: #d1d5db;
      --text-muted: #9ca3af;
      --border: #4b5563;
      --border-light: #6b7280;
    }

    /* Tema claro */
    [data-theme="light"] {
      --bg-primary: #f8fafc;
      --bg-secondary: #f1f5f9;
      --bg-card: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --border-light: #cbd5e1;
    }

    * { box-sizing: border-box; }
    
    body {
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-card) 100%);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      margin: 0;
      line-height: 1.5;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .main-header {
      background: rgba(17, 24, 39, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      padding: 1rem 0;
      position: sticky;
      top: 0;
      z-index: 50;
      transition: background 0.3s ease;
    }

    [data-theme="light"] .main-header {
      background: rgba(248, 250, 252, 0.95);
    }

    .main-title {
      font-size: 2rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
      margin: 0;
    }

    .main-subtitle {
      text-align: center;
      color: var(--text-secondary);
      margin-top: 0.25rem;
      font-size: 0.875rem;
    }

    .header-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-top: 1rem;
    }

    .theme-toggle {
      background: rgba(55, 65, 81, 0.8);
      border: 2px solid var(--border);
      border-radius: 25px;
      color: var(--text-primary);
      padding: 0.5rem 1rem;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    [data-theme="light"] .theme-toggle {
      background: rgba(255, 255, 255, 0.9);
    }

    .theme-toggle:hover {
      border-color: var(--primary);
      transform: translateY(-1px);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .auth-container {
      max-width: 400px;
      margin: 2rem auto;
      padding: 2rem;
      background: rgba(55, 65, 81, 0.4);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
      border-radius: 16px;
      transition: all 0.3s ease;
    }

    [data-theme="light"] .auth-container {
      background: rgba(255, 255, 255, 0.7);
    }

    .auth-title {
      font-size: 1.5rem;
      font-weight: 800;
      text-align: center;
      margin-bottom: 1.5rem;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .form-group {
      margin-bottom: 0.75rem;
    }

    .form-label {
      display: block;
      font-weight: 600;
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 0.375rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: rgba(17, 24, 39, 0.8);
      color: var(--text-primary);
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }

    [data-theme="light"] .form-input,
    [data-theme="light"] .form-select {
      background: rgba(255, 255, 255, 0.9);
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-secondary {
      background: rgba(55, 65, 81, 0.8);
      color: var(--text-primary);
      border: 2px solid var(--border);
      transition: all 0.3s ease;
    }

    [data-theme="light"] .btn-secondary {
      background: rgba(255, 255, 255, 0.9);
    }

    .btn-secondary:hover {
      border-color: var(--border-light);
      transform: translateY(-1px);
    }

    .subscription-plans {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 2rem 0;
    }

    .plan-card {
      background: rgba(31, 41, 59, 0.8);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    [data-theme="light"] .plan-card {
      background: rgba(255, 255, 255, 0.9);
    }

    .plan-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .plan-card.popular {
      border-color: var(--primary);
      position: relative;
    }

    .plan-card.popular::before {
      content: 'POPULAR';
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.625rem;
      font-weight: 700;
    }

    .plan-name {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .plan-price {
      font-size: 1.75rem;
      font-weight: 800;
      color: var(--primary);
      font-family: ui-monospace, monospace;
    }

    .plan-period {
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    .plan-discount {
      background: linear-gradient(135deg, var(--success), var(--secondary-dark));
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 600;
      margin: 0.5rem 0;
      display: inline-block;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 1rem;
      background: rgba(31, 41, 59, 0.6);
      border-radius: 8px;
      margin-left: auto;
    }

    [data-theme="light"] .user-info {
      background: rgba(255, 255, 255, 0.7);
    }

    .user-email {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .user-status {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--success);
    }

    .user-expires {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .logout-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.75rem;
      transition: all 0.2s ease;
    }

    .logout-btn:hover {
      border-color: var(--danger);
      color: var(--danger);
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hidden { display: none !important; }

    .tabs-container {
      background: rgba(31, 41, 59, 0.8);
      border-radius: 12px;
      padding: 0.5rem;
      display: flex;
      gap: 0.25rem;
      margin: 1.5rem auto;
      max-width: 500px;
      border: 1px solid var(--border);
      transition: background 0.3s ease;
    }

    [data-theme="light"] .tabs-container {
      background: rgba(255, 255, 255, 0.9);
    }

    .tab {
      flex: 1;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .tab[aria-selected="true"] {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      transform: translateY(-1px);
    }

    .tab:hover:not([aria-selected="true"]) {
      background: rgba(59, 130, 246, 0.1);
      color: var(--text-primary);
    }

    .panel {
      background: rgba(55, 65, 81, 0.4);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.5rem;
      margin: 1rem 0;
      transition: background 0.3s ease;
    }

    [data-theme="light"] .panel {
      background: rgba(255, 255, 255, 0.7);
    }

    .card {
      background: rgba(31, 41, 59, 0.8);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
    }

    [data-theme="light"] .card {
      background: rgba(255, 255, 255, 0.9);
    }

    .card:hover {
      border-color: var(--border-light);
      transform: translateY(-1px);
    }

    .section-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-title::before {
      content: '';
      width: 3px;
      height: 20px;
      background: linear-gradient(180deg, var(--primary), var(--secondary));
      border-radius: 2px;
    }

    .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }
    .grid-auto { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }

    .btn-toggle {
      background: rgba(55, 65, 81, 0.8);
      color: var(--text-secondary);
      border: 2px solid var(--border);
      min-width: 60px;
      padding: 0.75rem 1rem;
      transition: all 0.3s ease;
    }

    [data-theme="light"] .btn-toggle {
      background: rgba(255, 255, 255, 0.9);
    }

    .btn-toggle.active {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border-color: var(--primary);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }

    .stat-card {
      background: rgba(17, 24, 39, 0.6);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      transition: all 0.3s ease;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    [data-theme="light"] .stat-card {
      background: rgba(255, 255, 255, 0.8);
    }

    .stat-card:hover {
      border-color: var(--border-light);
    }

    .stat-value {
      font-size: 1.25rem;
      font-weight: 800;
      font-family: ui-monospace, monospace;
      margin-bottom: 0.25rem;
      color: var(--primary);
    }

    .stat-label {
      font-size: 0.625rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
    }

    .house-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .house-card {
      background: linear-gradient(135deg, rgba(31, 41, 59, 0.8), rgba(55, 65, 81, 0.6));
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
      transition: all 0.3s ease;
      position: relative;
    }

    [data-theme="light"] .house-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.8));
    }

    .house-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      border-radius: 12px 12px 0 0;
    }

    .house-card:hover {
      transform: translateY(-2px);
      border-color: var(--border-light);
    }

    .house-title {
      font-size: 0.875rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.75rem;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0.5rem 0;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .checkbox-group input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--primary);
    }

    .results-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(17, 24, 39, 0.8);
      border-radius: 12px;
      overflow: hidden;
      margin-top: 1rem;
      transition: background 0.3s ease;
    }

    [data-theme="light"] .results-table {
      background: rgba(255, 255, 255, 0.9);
    }

    .results-table th {
      background: rgba(17, 24, 39, 0.9);
      color: var(--text-primary);
      font-weight: 700;
      text-transform: uppercase;
      padding: 0.75rem 0.5rem;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      border-bottom: 2px solid var(--primary);
      transition: background 0.3s ease;
    }

    [data-theme="light"] .results-table th {
      background: rgba(248, 250, 252, 0.9);
    }

    .results-table td {
      padding: 0.75rem 0.5rem;
      border-bottom: 1px solid var(--border);
      color: var(--text-primary);
      font-size: 0.875rem;
    }

    .results-table th:first-child,
    .results-table td:first-child {
      text-align: left;
    }

    .results-table th:not(:first-child),
    .results-table td:not(:first-child) {
      text-align: right;
    }

    .profit-positive { color: #22c55e !important; font-weight: 700 !important; }
    .profit-negative { color: #dc2626 !important; font-weight: 700 !important; }
    .profit-highlight { color: #3b82f6 !important; font-weight: 800 !important; }

    .text-small { font-size: 0.75rem; color: var(--text-muted); }

    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type=number] {
      -moz-appearance: textfield;
    }

    @media (max-width: 900px) {
      .grid-2, .grid-3, .grid-4, .grid-auto {
        grid-template-columns: 1fr;
      }
      .house-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .main-title { font-size: 1.75rem; }
      .container { padding: 0 0.75rem; }
      .panel { padding: 1rem; }
      .tabs-container {
        flex-direction: column;
        gap: 0.25rem;
      }
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
      }
      .header-controls {
        margin-top: 0.75rem;
      }
    }

    @media (max-width: 480px) {
      .main-title { font-size: 1.5rem; }
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .stat-card {
        min-height: 70px;
        padding: 0.75rem;
      }
      .results-table {
        font-size: 0.75rem;
      }
      .results-table th,
      .results-table td {
        padding: 0.5rem 0.25rem;
      }
      .header-controls {
        flex-direction: column;
        gap: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <header class="main-header">
    <div class="container">
      <h1 class="main-title">FreePro</h1>
      <p class="main-subtitle">Ferramentas profissionais para otimiza√ß√£o de apostas esportivas</p>
      <div class="header-controls">
        <button id="themeToggle" class="theme-toggle">
          üåô Tema Escuro
        </button>
        
        <!-- Informa√ß√µes do usu√°rio -->
        <div id="userInfo" class="user-info hidden">
          <div>
            <div id="userEmail" class="user-email"></div>
            <div id="userStatus" class="user-status"></div>
            <div id="userExpires" class="user-expires"></div>
          </div>
          <button id="logoutBtn" class="logout-btn">Sair</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Tela de Login -->
  <div id="loginScreen" class="container">
    <div class="auth-container">
      <h2 class="auth-title">Acesso FreePro</h2>
      
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label" for="loginEmail">E-mail</label>
          <input type="email" id="loginEmail" class="form-input" required placeholder="seu@email.com" />
        </div>
        
        <div class="form-group">
          <label class="form-label" for="loginPassword">Senha</label>
          <input type="password" id="loginPassword" class="form-input" required placeholder="Sua senha" />
        </div>
        
        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
          <span id="loginText">Entrar</span>
          <div id="loginSpinner" class="loading-spinner hidden" style="margin: 0 auto;"></div>
        </button>
      </form>
      
      <div style="text-align: center; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border);">
        <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 1rem;">
          N√£o tem acesso ainda?
        </p>
        <button id="showPlansBtn" class="btn btn-secondary">Ver Planos de Assinatura</button>
      </div>
    </div>
  </div>

  <!-- Tela de Assinatura Expirada -->
  <div id="expiredScreen" class="container hidden">
    <div class="auth-container">
      <h2 class="auth-title" style="color: var(--warning);">‚ö†Ô∏è Assinatura Expirada</h2>
      <p style="color: var(--text-secondary); margin-bottom: 2rem; text-align: center;">
        Sua assinatura FreePro expirou. Renove agora para continuar usando as calculadoras profissionais.
      </p>
      <button id="renewSubscriptionBtn" class="btn btn-primary" style="width: 100%;">Renovar Assinatura</button>
    </div>
  </div>

  <!-- Tela de Planos -->
  <div id="plansScreen" class="container hidden">
    <div style="text-align: center; margin: 2rem 0;">
      <h2 class="auth-title">Escolha seu Plano FreePro</h2>
      <p style="color: var(--text-secondary); margin-bottom: 2rem;">
        Acesso completo √†s calculadoras profissionais de arbitragem
      </p>
    </div>
    
    <div class="subscription-plans">
      <div class="plan-card" data-plan="monthly">
        <div class="plan-name">Mensal</div>
        <div class="plan-price">R$ 9,90</div>
        <div class="plan-period">por m√™s</div>
      </div>
      
      <div class="plan-card" data-plan="quarterly">
        <div class="plan-name">Trimestral</div>
        <div class="plan-price">R$ 26,90</div>
        <div class="plan-period">por 3 meses</div>
        <div class="plan-discount">10% desconto</div>
      </div>
      
      <div class="plan-card popular" data-plan="biannual">
        <div class="plan-name">Semestral</div>
        <div class="plan-price">R$ 47,90</div>
        <div class="plan-period">por 6 meses</div>
        <div class="plan-discount">20% desconto</div>
      </div>
      
      <div class="plan-card" data-plan="annual">
        <div class="plan-name">Anual</div>
        <div class="plan-price">R$ 79,90</div>
        <div class="plan-period">por ano</div>
        <div class="plan-discount">33% desconto</div>
      </div>
    </div>
    
    <div style="text-align: center; margin-top: 2rem;">
      <button id="backToLoginBtn" class="btn btn-secondary">Voltar ao Login</button>
    </div>
  </div>

  <!-- Conte√∫do Principal (protegido) -->
  <div id="mainContent" class="container hidden">
    <div role="tablist" aria-label="Calculadoras" class="tabs-container">
      <button id="tabBtn1" role="tab" aria-selected="true" aria-controls="panel-1" class="tab" tabindex="0">
        Calculadora ArbiPro
      </button>
      <button id="tabBtn2" role="tab" aria-selected="false" aria-controls="panel-2" class="tab" tabindex="-1">
        Calculadora FreePro
      </button>
    </div>

    <section id="panel-1" role="tabpanel" aria-labelledby="tabBtn1">
      <div class="panel">
        <div id="app"></div>
      </div>
    </section>

    <section id="panel-2" role="tabpanel" aria-labelledby="tabBtn2" hidden>
      <div class="panel">
        <iframe id="calc2frame" title="Calculadora FreePro" style="width: 100%; height: auto; border: none; border-radius: 16px; background: transparent; display: block; overflow: hidden;" scrolling="no"></iframe>
      </div>
    </section>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    
    const firebaseConfig = {
      apiKey: "AIzaSyC6-O6BnUXGzwXwcRM_wRYwGUNFuRpT7NI",
      authDomain: "calculadora-free-pro.firebaseapp.com",
      projectId: "calculadora-free-pro",
      storageBucket: "calculadora-free-pro.firebasestorage.app",
      messagingSenderId: "313485499345",
      appId: "1:313485499345:web:020a4d47f6de604c129ef0",
      measurementId: "G-X7QJD503L6"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // Disponibilizar globalmente
    window.firebaseDb = db;
    window.firebaseGetDoc = getDoc;
    window.firebaseDoc = doc;
  </script>

  <!-- Sistema de autentica√ß√£o -->
  <script>
    const FreePro = {
      currentUser: null,
      
      // Elementos DOM
      elements: {
        loginScreen: null,
        expiredScreen: null,
        plansScreen: null,
        mainContent: null,
        userInfo: null,
        loginForm: null,
        loginEmail: null,
        loginPassword: null,
        loginText: null,
        loginSpinner: null,
        userEmailSpan: null,
        userStatusSpan: null,
        userExpiresSpan: null,
        themeToggle: null
      },

      // Inicializa√ß√£o
      init() {
        this.bindElements();
        this.initTheme();
        this.bindEvents();
        this.autoLogin();
      },

      bindElements() {
        this.elements.loginScreen = document.getElementById('loginScreen');
        this.elements.expiredScreen = document.getElementById('expiredScreen');
        this.elements.plansScreen = document.getElementById('plansScreen');
        this.elements.mainContent = document.getElementById('mainContent');
        this.elements.userInfo = document.getElementById('userInfo');
        this.elements.loginForm = document.getElementById('loginForm');
        this.elements.loginEmail = document.getElementById('loginEmail');
        this.elements.loginPassword = document.getElementById('loginPassword');
        this.elements.loginText = document.getElementById('loginText');
        this.elements.loginSpinner = document.getElementById('loginSpinner');
        this.elements.userEmailSpan = document.getElementById('userEmail');
        this.elements.userStatusSpan = document.getElementById('userStatus');
        this.elements.userExpiresSpan = document.getElementById('userExpires');
        this.elements.themeToggle = document.getElementById('themeToggle');
      },

      bindEvents() {
        // Login
        this.elements.loginForm.addEventListener('submit', (e) => {
          e.preventDefault();
          this.loginUser(this.elements.loginEmail.value.trim(), this.elements.loginPassword.value);
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => this.logout());

        // Navega√ß√£o
        document.getElementById('showPlansBtn').addEventListener('click', () => this.showScreen('plans'));
        document.getElementById('backToLoginBtn').addEventListener('click', () => this.showScreen('login'));
        document.getElementById('renewSubscriptionBtn').addEventListener('click', () => this.showScreen('plans'));

  // Planos
document.querySelectorAll('.plan-card').forEach(card => {
  card.addEventListener('click', () => {
    const plan = card.dataset.plan;
    
    // URLs corretas do LastLink
    const planUrls = {
      monthly: 'https://lastlink.com/p/C84FEE0AA/checkout-payment/',
      quarterly: 'https://lastlink.com/p/C22278B31/checkout-payment/',
      biannual: 'https://lastlink.com/p/C1D318901/checkout-payment/',
      annual: 'https://lastlink.com/p/C479D71C2/checkout-payment/'
    };
    
    const url = planUrls[plan];
    if (url) {
      // Adicionar email do usu√°rio se dispon√≠vel para pr√©-preenchimento
      const userEmail = this.currentUser?.email;
      const finalUrl = userEmail ? `${url}?email=${encodeURIComponent(userEmail)}` : url;
      window.open(finalUrl, '_blank');
    } else {
      console.error('URL n√£o encontrada para o plano:', plan);
    }
  });
});

// Bot√£o de renova√ß√£o na tela expirada
document.getElementById('renewSubscriptionBtn').addEventListener('click', () => {
  // Redirecionar para o plano mais popular (semestral) ou permitir escolha
  window.open('https://lastlink.com/p/C1D318901/checkout-payment/', '_blank');
});

        // Tema
        this.elements.themeToggle.addEventListener('click', () => this.toggleTheme());
      },

      // Sistema de temas
      initTheme() {
        const savedTheme = localStorage.getItem('freepro-theme') || 'dark';
        this.setTheme(savedTheme);
      },

      setTheme(theme) {
        const body = document.body;
        if (theme === 'light') {
          body.setAttribute('data-theme', 'light');
          this.elements.themeToggle.innerHTML = '‚òÄÔ∏è Tema Claro';
        } else {
          body.removeAttribute('data-theme');
          this.elements.themeToggle.innerHTML = 'üåô Tema Escuro';
        }
        localStorage.setItem('freepro-theme', theme);
      },

      toggleTheme() {
        const currentTheme = document.body.getAttribute('data-theme') === 'light' ? 'light' : 'dark';
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        this.setTheme(newTheme);
      },

      // Utilit√°rios
      showScreen(screen) {
        const screens = {
          login: this.elements.loginScreen,
          expired: this.elements.expiredScreen,
          plans: this.elements.plansScreen,
          main: this.elements.mainContent
        };
        
        Object.values(screens).forEach(s => s.classList.add('hidden'));
        screens[screen].classList.remove('hidden');
      },

      formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
          return new Date(dateString).toLocaleDateString('pt-BR');
        } catch {
          return 'N/A';
        }
      },

      // Firebase
      async checkSubscription(email) {
        try {
          if (!window.firebaseDb) {
            console.log('Firebase n√£o inicializado');
            return { valid: false, reason: 'firebase_not_ready' };
          }
          
          console.log('=== DEBUG LOGIN ===');
          console.log('Email procurado:', `"${email}"`);
          console.log('Tamanho do email:', email.length);
          
          // Importa as fun√ß√µes necess√°rias dinamicamente
          const { collection, getDocs, query, where } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
          
          // Primeira tentativa: buscar por ID do documento
          const docRef = window.firebaseDoc(window.firebaseDb, 'users', email);
          console.log('Refer√™ncia do documento:', docRef.path);
          
          let docSnap = await window.firebaseGetDoc(docRef);
          console.log('Documento existe por ID?', docSnap.exists());
          
          let userData = null;
          
          if (docSnap.exists()) {
            userData = docSnap.data();
            console.log('Dados encontrados por ID:', userData);
          } else {
            // Segunda tentativa: buscar por campo email
            console.log('Tentando buscar por campo email...');
            
            const usersRef = collection(window.firebaseDb, 'users');
            const q = query(usersRef, where("email", "==", email));
            const querySnapshot = await getDocs(q);
            
            console.log('Documentos encontrados por email:', querySnapshot.size);
            
            if (!querySnapshot.empty) {
              querySnapshot.forEach((doc) => {
                console.log('Documento encontrado:', doc.id, doc.data());
                userData = doc.data();
              });
            }
          }
          
          if (!userData) {
            console.log('‚ùå Usu√°rio n√£o encontrado de forma alguma');
            
            // Lista todos os documentos para debug
            console.log('=== LISTANDO TODOS OS DOCUMENTOS ===');
            const allDocsSnapshot = await getDocs(collection(window.firebaseDb, 'users'));
            console.log('Total de documentos:', allDocsSnapshot.size);
            allDocsSnapshot.forEach((doc) => {
              console.log('ID:', `"${doc.id}"`, '| Email:', doc.data().email, '| Status:', doc.data().status);
            });
            
            return { valid: false, reason: 'user_not_found' };
          }
          
          console.log('‚úÖ Dados do usu√°rio encontrado:', userData);
          
          // Verifica status
          if (userData.status !== 'active') {
            console.log('‚ùå Status inativo:', userData.status);
            return { valid: false, reason: 'inactive', userData };
          }
          
          // Verifica data de expira√ß√£o
          const now = new Date();
          let expiresAt = null;
          
          if (userData.expiresAt) {
            if (typeof userData.expiresAt === 'string') {
              // Tenta diferentes formatos de string
              if (userData.expiresAt.includes('de') && userData.expiresAt.includes('UTC')) {
                // Formato brasileiro do Firestore: "1 de outubro de 2025 √†s 00:00:00 UTC-3"
                // Converte para formato que JS entende
                let dateStr = userData.expiresAt
                  .replace(' de outubro de ', '/10/')
                  .replace(' de novembro de ', '/11/')
                  .replace(' de dezembro de ', '/12/')
                  .replace(' de janeiro de ', '/01/')
                  .replace(' de fevereiro de ', '/02/')
                  .replace(' de mar√ßo de ', '/03/')
                  .replace(' de abril de ', '/04/')
                  .replace(' de maio de ', '/05/')
                  .replace(' de junho de ', '/06/')
                  .replace(' de julho de ', '/07/')
                  .replace(' de agosto de ', '/08/')
                  .replace(' de setembro de ', '/09/')
                  .replace(' √†s ', ' ')
                  .replace(' UTC-3', '');
                
                console.log('Convertendo data brasileira:', userData.expiresAt, '->', dateStr);
                expiresAt = new Date(dateStr);
              } else {
                expiresAt = new Date(userData.expiresAt);
              }
              
              console.log('Data processada:', expiresAt);
            } else if (userData.expiresAt.toDate) {
              // Timestamp do Firestore
              expiresAt = userData.expiresAt.toDate();
              console.log('Convertendo Timestamp para data:', expiresAt);
            }
          }
          
          console.log('Data atual:', now);
          console.log('Data de expira√ß√£o:', expiresAt);
          console.log('Data v√°lida?', expiresAt && !isNaN(expiresAt.getTime()));
          
          if (!expiresAt || isNaN(expiresAt.getTime())) {
            console.log('‚ùå Data de expira√ß√£o inv√°lida');
            return { valid: false, reason: 'invalid_date', userData };
          }
          
          console.log('Ainda v√°lida?', expiresAt > now);
          
          if (expiresAt <= now) {
            console.log('‚ùå Assinatura expirada');
            return { valid: false, reason: 'expired', userData };
          }
          
          console.log('‚úÖ Assinatura v√°lida!');
          return { valid: true, userData };
          
        } catch (error) {
          console.error('‚ùå Erro ao verificar assinatura:', error);
          return { valid: false, reason: 'error', error: error.message };
        }
      },

      // Autentica√ß√£o
      async loginUser(email, password) {
        try {
          this.elements.loginText.classList.add('hidden');
          this.elements.loginSpinner.classList.remove('hidden');
          
          if (password.length < 6) {
            throw new Error('Senha deve ter pelo menos 6 caracteres');
          }

          // Aguarda o Firebase estar pronto
          let attempts = 0;
          while (!window.firebaseDb && attempts < 10) {
            await new Promise(resolve => setTimeout(resolve, 500));
            attempts++;
          }

          if (!window.firebaseDb) {
            throw new Error('Sistema n√£o inicializado. Recarregue a p√°gina.');
          }
          
          const subscriptionCheck = await this.checkSubscription(email);
          console.log('Subscription check result:', subscriptionCheck);
          
          if (!subscriptionCheck.valid) {
            if (subscriptionCheck.reason === 'user_not_found') {
              throw new Error('Usu√°rio n√£o encontrado. Verifique o e-mail ou adquira uma assinatura.');
            }
            if (subscriptionCheck.reason === 'expired') {
              this.currentUser = { email, ...subscriptionCheck.userData };
              localStorage.setItem('freepro_user', JSON.stringify(this.currentUser));
              this.showScreen('expired');
              this.updateUserInfo();
              return;
            }
            if (subscriptionCheck.reason === 'inactive') {
              throw new Error('Assinatura inativa. Entre em contato com o suporte.');
            }
            throw new Error('Erro na verifica√ß√£o da assinatura: ' + subscriptionCheck.reason);
          }
          
          this.currentUser = { email, ...subscriptionCheck.userData };
          localStorage.setItem('freepro_user', JSON.stringify(this.currentUser));
          this.showScreen('main');
          this.updateUserInfo();
          
          // Aguarda um pouco antes de inicializar as calculadoras
          setTimeout(() => this.initCalculators(), 300);
          
        } catch (error) {
          console.error('Erro no login:', error);
          alert('Erro no login: ' + error.message);
        } finally {
          this.elements.loginText.classList.remove('hidden');
          this.elements.loginSpinner.classList.add('hidden');
        }
      },

      logout() {
        this.currentUser = null;
        localStorage.removeItem('freepro_user');
        this.showScreen('login');
        this.updateUserInfo();
      },

      async autoLogin() {
        const savedUser = localStorage.getItem('freepro_user');
        if (!savedUser) {
          this.showScreen('login');
          return;
        }
        
        try {
          const userData = JSON.parse(savedUser);
          const subscriptionCheck = await this.checkSubscription(userData.email);
          
          if (subscriptionCheck.valid) {
            this.currentUser = { ...userData, ...subscriptionCheck.userData };
            localStorage.setItem('freepro_user', JSON.stringify(this.currentUser));
            this.showScreen('main');
            this.updateUserInfo();
            this.initCalculators();
          } else if (subscriptionCheck.reason === 'expired') {
            this.currentUser = { ...userData, ...subscriptionCheck.userData };
            localStorage.setItem('freepro_user', JSON.stringify(this.currentUser));
            this.showScreen('expired');
            this.updateUserInfo();
          } else {
            this.logout();
          }
        } catch (error) {
          console.error('Erro no auto-login:', error);
          this.logout();
        }
      },

      updateUserInfo() {
        if (this.currentUser) {
          this.elements.userInfo.classList.remove('hidden');
          this.elements.userEmailSpan.textContent = this.currentUser.email;
          this.elements.userStatusSpan.textContent = this.currentUser.status === 'active' ? 'Ativa' : 'Expirada';
          this.elements.userStatusSpan.style.color = this.currentUser.status === 'active' ? 'var(--success)' : 'var(--warning)';
          this.elements.userExpiresSpan.textContent = `Expira em: ${this.formatDate(this.currentUser.expiresAt)}`;
        } else {
          this.elements.userInfo.classList.add('hidden');
        }
      },

      // Calculadoras
      initCalculators() {
        if (document.querySelector('#app').innerHTML.trim()) return;
        
        setTimeout(() => {
          this.initTabSystem();
          this.initArbiPro();
        }, 100);
      },

      // Sistema de abas
      initTabSystem() {
        const tabs = Array.from(document.querySelectorAll('[role="tab"]'));
        const panels = [document.getElementById('panel-1'), document.getElementById('panel-2')];
        const iframe = document.getElementById('calc2frame');

        const setActive = (index) => {
          tabs.forEach((t,i) => {
            const selected = i === index;
            t.setAttribute('aria-selected', selected ? 'true' : 'false');
            t.tabIndex = selected ? 0 : -1;
            panels[i].hidden = !selected;
          });
          if (index === 1 && !iframe.dataset.loaded) this.loadFreePro();
          tabs[index].focus();
        };

        tabs[0].addEventListener('click', () => setActive(0));
        tabs[1].addEventListener('click', () => setActive(1));

        document.querySelector('[role="tablist"]').addEventListener('keydown', (e) => {
          const current = tabs.findIndex(t => t.getAttribute('aria-selected') === 'true');
          let next = current;
          if (e.key === 'ArrowRight') next = (current + 1) % tabs.length;
          else if (e.key === 'ArrowLeft') next = (current - 1 + tabs.length) % tabs.length;
          else if (e.key === 'Home') next = 0;
          else if (e.key === 'End') next = tabs.length - 1;
          else return;
          e.preventDefault();
          setActive(next);
        });
      },

      // Calculadora FreePro (implementa√ß√£o da sua segunda calculadora)
      loadFreePro() {
        const iframe = document.getElementById('calc2frame');
        const html = `<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora FreePro</title>
  <style>
    :root {
      --primary: #3b82f6;
      --secondary: #22c55e;
      --accent: #8b5cf6;
      --warning: #f59e0b;
      --danger: #dc2626;
      --success: #22c55e;
      --bg-primary: #111827;
      --bg-secondary: #1f2937;
      --bg-card: #374151;
      --text-primary: #f9fafb;
      --text-secondary: #d1d5db;
      --text-muted: #9ca3af;
      --border: #4b5563;
    }

    /* Tema claro para iframe */
    [data-theme="light"] {
      --bg-primary: #f8fafc;
      --bg-secondary: #f1f5f9;
      --bg-card: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --border: #e2e8f0;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    html, body {
      background: transparent;
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.5;
      padding: 1rem;
      margin: 0;
      overflow: visible;
      height: auto;
      transition: color 0.3s ease;
    }

    .calc-header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .calc-title {
      font-size: 1.75rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.5rem;
    }

    .calc-subtitle {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .card {
      background: rgba(31, 41, 59, 0.8);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    [data-theme="light"] .card {
      background: rgba(255, 255, 255, 0.9);
    }

    .card-promo {
      border-left: 3px solid var(--primary);
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(31, 41, 59, 0.8));
    }

    [data-theme="light"] .card-promo {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(255, 255, 255, 0.9));
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .card-title {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .badge {
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.625rem;
      font-weight: 600;
      text-transform: uppercase;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
    }

    .form-grid {
      display: grid;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .form-grid-3 { grid-template-columns: repeat(3, 1fr); }
    .form-grid-auto { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }

    .form-group {
      margin-bottom: 0.75rem;
    }

    .form-label {
      display: block;
      font-weight: 600;
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 0.375rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .form-control {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: rgba(17, 24, 39, 0.8);
      color: var(--text-primary);
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }

    [data-theme="light"] .form-control {
      background: rgba(255, 255, 255, 0.9);
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .coverage-grid {
      display: grid;
      gap: 0.75rem;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }

    .coverage-card {
      background: rgba(17, 24, 39, 0.6);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      border-left: 3px solid var(--primary);
      transition: background 0.3s ease;
    }

    [data-theme="light"] .coverage-card {
      background: rgba(255, 255, 255, 0.8);
    }

    .coverage-card:nth-child(1) { border-left-color: var(--success); }
    .coverage-card:nth-child(2) { border-left-color: var(--warning); }
    .coverage-card:nth-child(3) { border-left-color: var(--danger); }
    .coverage-card:nth-child(4) { border-left-color: var(--primary); }
    .coverage-card:nth-child(5) { border-left-color: var(--accent); }

    .coverage-title {
      font-weight: 700;
      font-size: 0.875rem;
      color: var(--text-primary);
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .coverage-fields {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 0.75rem;
      align-items: end;
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      border: 2px dashed var(--border);
      border-radius: 8px;
      cursor: pointer;
      min-height: 48px;
      transition: all 0.2s ease;
    }

    .checkbox-wrapper:hover {
      border-color: var(--primary);
      background: rgba(59, 130, 246, 0.05);
    }

    .total-display {
      text-align: center;
      padding: 1.5rem;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(34, 197, 94, 0.05));
      border: 2px solid var(--primary);
      border-radius: 12px;
      margin: 1rem 0;
    }

    .total-value {
      font-size: 1.75rem;
      font-weight: 800;
      color: var(--primary);
      font-family: ui-monospace, monospace;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: uppercase;
      font-size: 0.75rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
    }

    .btn-secondary {
      background: rgba(55, 65, 81, 0.8);
      color: var(--text-primary);
      border: 2px solid var(--border);
      transition: all 0.3s ease;
    }

    [data-theme="light"] .btn-secondary {
      background: rgba(255, 255, 255, 0.9);
    }

    .actions {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
      margin: 1.5rem 0;
    }

    .alert {
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      font-weight: 600;
      display: none;
    }

    .alert-warning {
      background: rgba(245, 158, 11, 0.1);
      border: 2px solid var(--warning);
      color: #fbbf24;
    }

    .results-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(17, 24, 39, 0.8);
      border-radius: 12px;
      overflow: hidden;
      margin-top: 1rem;
      transition: background 0.3s ease;
    }

    [data-theme="light"] .results-table {
      background: rgba(255, 255, 255, 0.9);
    }

    .results-table th {
      background: rgba(17, 24, 39, 0.9);
      color: var(--text-primary);
      font-weight: 700;
      text-transform: uppercase;
      padding: 0.75rem 0.5rem;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      border-bottom: 2px solid var(--primary);
      transition: background 0.3s ease;
    }

    [data-theme="light"] .results-table th {
      background: rgba(248, 250, 252, 0.9);
    }

    .results-table td {
      padding: 0.75rem 0.5rem;
      border-bottom: 1px solid var(--border);
      color: var(--text-primary);
      font-size: 0.875rem;
    }

    .results-table th:first-child,
    .results-table td:first-child { text-align: left; }

    .results-table th:not(:first-child),
    .results-table td:not(:first-child) { text-align: right; }

    .profit-positive { color: #22c55e !important; font-weight: 700 !important; }
    .profit-negative { color: #dc2626 !important; font-weight: 700 !important; }
    .profit-highlight { color: #3b82f6 !important; font-weight: 800 !important; }
    .text-small { font-size: 0.75rem; color: var(--text-muted); }

    @media (max-width: 900px) {
      .form-grid-3, .form-grid-auto { 
        grid-template-columns: 1fr; 
      }
      .coverage-fields { 
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }
    }

    @media (max-width: 768px) {
      .calc-header h1 {
        font-size: 1.5rem;
      }
      .coverage-grid {
        grid-template-columns: 1fr;
      }
      .actions {
        flex-direction: column;
        gap: 0.5rem;
      }
      .results-table {
        font-size: 0.75rem;
      }
      .results-table th,
      .results-table td {
        padding: 0.5rem 0.25rem;
      }
    }
  </style>
</head>
<body>
  <div class="calc-header">
    <h1 class="calc-title">Calculadora FreePro</h1>
    <p class="calc-subtitle">Otimize seus lucros com freebets de apostas seguras - estrat√©gias para perder a qualifica√ß√£o e ganhar a freebet</p>
  </div>

  <div class="card">
    <div class="form-group">
      <label class="form-label" for="numEntradas">N√∫mero de Entradas</label>
      <select id="numEntradas" class="form-control">
        <option value="2">2 Mercados</option>
        <option value="3" selected>3 Mercados</option>
        <option value="4">4 Mercados</option>
        <option value="5">5 Mercados</option>
        <option value="6">6 Mercados</option>
      </select>
    </div>
  </div>

  <div class="card card-promo">
    <div class="card-header">
      <div class="card-title">Casa Promo√ß√£o</div>
      <div class="badge">FreePro</div>
    </div>
    <div class="form-grid form-grid-3">
      <div class="form-group">
        <label class="form-label" for="o1">Odd da Casa</label>
        <input id="o1" class="form-control" placeholder="ex: 3.00" inputmode="decimal" />
      </div>
      <div class="form-group">
        <label class="form-label" for="c1">Comiss√£o (%)</label>
        <input id="c1" class="form-control" placeholder="ex: 0" inputmode="decimal" />
      </div>
      <div class="form-group">
        <label class="form-label" for="s1">Stake Qualifica√ß√£o</label>
        <input id="s1" class="form-control" placeholder="ex: 50" inputmode="decimal" />
      </div>
    </div>
    <div class="form-grid form-grid-3">
      <div class="form-group">
        <label class="form-label" for="F">Valor da Freebet</label>
        <input id="F" class="form-control" placeholder="ex: 50" inputmode="decimal" />
      </div>
      <div class="form-group">
        <label class="form-label" for="r">Taxa de Extra√ß√£o (%)</label>
        <input id="r" class="form-control" placeholder="ex: 70" inputmode="decimal" />
      </div>
      <div class="form-group">
        <label class="form-label" for="round_step">Arredondamento</label>
        <select id="round_step" class="form-control">
          <option value="0.01">R$ 0,01</option>
          <option value="0.10">R$ 0,10</option>
          <option value="0.50">R$ 0,50</option>
          <option value="1.00" selected>R$ 1,00</option>
        </select>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <div class="card-title">Coberturas</div>
    </div>
    <div id="oddsContainer" class="coverage-grid"></div>
  </div>

  <div class="total-display">
    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.375rem; text-transform: uppercase;">Stake Total</div>
    <div class="total-value" id="k_S">‚Äî</div>
  </div>

  <div class="actions">
    <button class="btn btn-primary" id="calcBtn">Calcular Estrat√©gia</button>
    <button class="btn btn-secondary" id="clearBtn">Limpar Dados</button>
  </div>

  <div id="status" class="alert alert-warning"></div>

  <div class="card" id="results" style="display:none">
    <div class="card-header">
      <div class="card-title">Resultados FreePro</div>
    </div>
    <div style="overflow-x:auto">
      <table class="results-table">
        <thead>
          <tr>
            <th>Cen√°rio</th>
            <th>Odd</th>
            <th>Comiss√£o</th>
            <th>Apostar</th>
            <th>D√©ficit</th>
            <th>Lucro Final</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

<script>
'use strict';

// Sincroniza√ß√£o de tema com parent
(() => {
  function syncTheme() {
    try {
      const parentTheme = parent.document.body.getAttribute('data-theme');
      if (parentTheme === 'light') {
        document.body.setAttribute('data-theme', 'light');
      } else {
        document.body.removeAttribute('data-theme');
      }
    } catch (e) {
      // Fallback se n√£o conseguir acessar o parent
    }
  }
  
  // Sincroniza tema inicial
  syncTheme();
  
  // Observa mudan√ßas no tema do parent
  try {
    const observer = new MutationObserver(syncTheme);
    observer.observe(parent.document.body, { 
      attributes: true, 
      attributeFilter: ['data-theme'] 
    });
  } catch (e) {
    // Fallback se n√£o conseguir observar o parent
  }
})();

(function(){
  function $(id){ return document.getElementById(id); }
  function nf(v){ return Number.isFinite(v) ? new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:2}).format(v) : '‚Äî'; }
  function toNum(s){ if(s===undefined||s===null) return NaN; var str=String(s).trim(); if(!str) return NaN; if(str.indexOf(',')!==-1 && str.indexOf('.')!==-1) return parseFloat(str.replace(/\\./g,'').replace(',','.')); if(str.indexOf(',')!==-1) return parseFloat(str.replace(',','.')); return parseFloat(str); }
  function showStatus(cls,msg){ var el=$("status"); el.className='alert alert-'+cls; el.style.display='block'; el.textContent=msg; }
  function hideStatus(){ $("status").style.display='none'; }
  function effOdd(o,c){ var cc=(Number.isFinite(c)&&c>0)?c/100:0; return 1+(o-1)*(1-cc); }

  function captureCoverageValues(){ var nodes=document.querySelectorAll('#oddsContainer > div'); var out=[]; for(var i=0;i<nodes.length;i++){ var odd=nodes[i].querySelector('input[data-type="odd"]'); var com=nodes[i].querySelector('input[data-type="comm"]'); var lay=nodes[i].querySelector('input[data-type="lay"]'); out.push({odd:odd?odd.value:'', com:com?com.value:'', lay:lay?lay.checked:false}); } return out; }

  function renderOddsInputs(){
    var n=parseInt($("numEntradas").value||'3',10);
    var prev=captureCoverageValues();
    var c=$("oddsContainer"); c.innerHTML='';
    var blocks=Math.max(1,n-1);
    for(var i=0;i<blocks;i++){
      var card=document.createElement('div'); 
      card.className='coverage-card';
      
      var title=document.createElement('div'); 
      title.className='coverage-title'; 
      title.innerHTML='<span style="width:10px;height:10px;border-radius:50%;background:currentColor;display:inline-block"></span>Resultado '+(i+2);
      
      var fieldsDiv=document.createElement('div'); 
      fieldsDiv.className='coverage-fields';
      
      var fOdd=document.createElement('div'); 
      fOdd.className='form-group';
      fOdd.style.margin='0';
      var lOdd=document.createElement('label'); 
      lOdd.className='form-label';
      lOdd.textContent='Odd'; 
      var iOdd=document.createElement('input'); 
      iOdd.className='form-control';
      iOdd.setAttribute('inputmode','decimal'); 
      iOdd.placeholder='ex: 2,50'; 
      iOdd.setAttribute('data-type','odd');
      
      var fCom=document.createElement('div'); 
      fCom.className='form-group';
      fCom.style.margin='0';
      var lCom=document.createElement('label'); 
      lCom.className='form-label';
      lCom.textContent='Comiss√£o (%)'; 
      var iCom=document.createElement('input'); 
      iCom.className='form-control';
      iCom.setAttribute('inputmode','decimal'); 
      iCom.placeholder='ex: 0'; 
      iCom.setAttribute('data-type','comm');
      
      var fLay=document.createElement('div'); 
      fLay.className='checkbox-wrapper'; 
      var iLay=document.createElement('input'); 
      iLay.type='checkbox'; 
      iLay.setAttribute('data-type','lay'); 
      var tLay=document.createElement('span'); 
      tLay.textContent='Lay';
      
      if(prev[i]){ 
        iOdd.value=prev[i].odd; 
        iCom.value=prev[i].com; 
        iLay.checked=!!prev[i].lay; 
      }
      
      fOdd.appendChild(lOdd); 
      fOdd.appendChild(iOdd);
      fCom.appendChild(lCom); 
      fCom.appendChild(iCom);
      fLay.appendChild(iLay); 
      fLay.appendChild(tLay);
      
      fieldsDiv.appendChild(fOdd); 
      fieldsDiv.appendChild(fCom); 
      fieldsDiv.appendChild(fLay);
      
      card.appendChild(title); 
      card.appendChild(fieldsDiv);
      c.appendChild(card);
    }
  }

  function readCoverage(){ var odds=[],comm=[],isLay=[]; var oInputs=document.querySelectorAll('#oddsContainer input[data-type="odd"]'); var cInputs=document.querySelectorAll('#oddsContainer input[data-type="comm"]'); var lInputs=document.querySelectorAll('#oddsContainer input[data-type="lay"]'); for(var i=0;i<oInputs.length;i++){odds.push(toNum(oInputs[i].value));} for(var j=0;j<cInputs.length;j++){comm.push(toNum(cInputs[j].value));} for(var k=0;k<lInputs.length;k++){isLay.push(!!lInputs[k].checked);} return {odds:odds,comm:comm,isLay:isLay}; }

  function calc(){
    hideStatus();
    var o1=toNum($("o1").value), c1=toNum($("c1").value), n=parseInt($("numEntradas").value||'3',10), cov=readCoverage(), F=toNum($("F").value), rPerc=toNum($("r").value), s1=toNum($("s1").value);
    if(!Number.isFinite(o1)||o1<=1){ showStatus('warning','Odd inv√°lida para Casa Promo'); return }
    if(cov.odds.length!==(n-1)||cov.odds.some(v=>!Number.isFinite(v)||v<=1)){ showStatus('warning','Informe '+(n-1)+' odds v√°lidas para coberturas'); return }
    if(!Number.isFinite(F)||F<0){ showStatus('warning','Valor da Freebet inv√°lido'); return }
    if(!Number.isFinite(rPerc)||rPerc<0||rPerc>100){ showStatus('warning','Taxa de extra√ß√£o deve estar entre 0-100%'); return }
    if(!Number.isFinite(s1)||s1<=0){ showStatus('warning','Stake de qualifica√ß√£o inv√°lido'); return }

    var o1e=effOdd(o1,c1), r=rPerc/100, rF=r*F;
    var A=s1*o1e - rF;

    var stakes=[],eBack=[],commFrac=[],oddsOrig=cov.odds.slice();
    for(var i=0;i<cov.odds.length;i++){
      var L=cov.odds[i], cfrac=(Number.isFinite(cov.comm[i])&&cov.comm[i]>0)?cov.comm[i]/100:0; commFrac[i]=cfrac;
      if(cov.isLay[i]){ var denom=L-1; if(!(denom>0)){showStatus('warning','Odd LAY inv√°lida'); return} var eLay=1+(1-cfrac)/denom; var equivStake=A/eLay; stakes[i]=equivStake/denom; eBack[i]=eLay; }
      else { var e=effOdd(L,cov.comm[i]); eBack[i]=e; stakes[i]=A/e; }
    }

    var step=parseFloat($("round_step").value)||1; function roundStep(v){return Math.round(v/step)*step;} stakes=stakes.map(roundStep);
    var liabilities=stakes.map((s,i)=>cov.isLay[i]?(cov.odds[i]-1)*s:0);
    var S=s1+stakes.reduce((a,s,idx)=>a+(cov.isLay[idx]?(cov.odds[idx]-1)*s:s),0);

    var net1=s1*o1e-S;

    var defs=[], nets=[];
    for(var win=0;win<stakes.length;win++){
      var deficit;
      if(cov.isLay[win]){ var ganhoLay=stakes[win]*(1-commFrac[win]); var liab=liabilities[win]; deficit=ganhoLay-(S-liab); }
      else { deficit=(stakes[win]*eBack[win]) - S; }
      defs[win]=deficit;
      nets[win]=deficit + rF;
    }

    $("k_S").textContent=nf(S);

    var tb=$("tbody"); tb.innerHTML='';
    function oddf(v){return Number.isFinite(v)?new Intl.NumberFormat('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v):'‚Äî';}
    function pf(v){return Number.isFinite(v)?new Intl.NumberFormat('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v)+'%':'‚Äî';}

    var rows=[[ '1 vence (Casa Promo)', o1, c1, s1, net1, net1, false, 0, '' ]];
    for(var k=0;k<stakes.length;k++){
      var isLay=cov.isLay[k]; var liab=liabilities[k];
      rows.push([ (k+2)+' vence', oddsOrig[k], cov.comm[k], stakes[k], defs[k], nets[k], isLay, liab, '' ]);
    }

    for(var rix=0; rix<rows.length; rix++){
      var nome=rows[rix][0], odd=rows[rix][1], comm=rows[rix][2], stake=rows[rix][3], deficit=rows[rix][4], final=rows[rix][5], isLayRow=rows[rix][6], liabRow=rows[rix][7];
      var apostarCell = '<strong>'+nf(stake)+'</strong>' + (isLayRow ? (' <span class="text-small">(resp. '+nf(liabRow)+')</span>') : '');
      var deficitClass = deficit >= 0 ? 'profit-positive' : 'profit-negative';
      var finalClass = final >= 0 ? 'profit-positive' : 'profit-negative';
      
      var tr=document.createElement('tr');
      tr.innerHTML = '<td><strong>'+nome+'</strong></td>'+
                     '<td>'+oddf(odd)+'</td>'+
                     '<td>'+pf(comm)+'</td>'+
                     '<td>'+apostarCell+'</td>'+
                     '<td class="'+deficitClass+'"><strong>'+nf(deficit)+'</strong></td>'+
                     '<td class="'+finalClass+'"><strong>'+nf(final)+'</strong></td>';
      tb.appendChild(tr);
    }
    $("results").style.display='block';
  }

  $("numEntradas").addEventListener('change', renderOddsInputs);
  $("calcBtn").addEventListener('click', calc);
  $("clearBtn").addEventListener('click', function(){ ["o1","c1","F","r","s1"].forEach(id=>$(id).value=''); $("tbody").innerHTML=''; $("results").style.display='none'; $("k_S").textContent='‚Äî'; hideStatus(); renderOddsInputs(); });

  window.addEventListener('DOMContentLoaded', function(){
    renderOddsInputs();
  });
})();
<\/script>
</body>
</html>`;

        const doc = (iframe.contentDocument || iframe.contentWindow.document);
        doc.open();
        doc.write(html);
        doc.close();
        
        function resizeIframe() {
          try {
            const body = doc.body;
            const html = doc.documentElement;
            
            const height = Math.max(
              body.scrollHeight,
              body.offsetHeight,
              html.clientHeight,
              html.scrollHeight,
              html.offsetHeight
            );
            
            iframe.style.height = (height + 20) + 'px';
          } catch (e) {
            iframe.style.height = '800px';
          }
        }
        
        setTimeout(resizeIframe, 100);
        
        if (doc.body) {
          const observer = new MutationObserver(() => {
            setTimeout(resizeIframe, 50);
          });
          observer.observe(doc.body, { 
            childList: true, 
            subtree: true, 
            attributes: true 
          });
        }
        
        iframe.dataset.loaded = "1";
      },

      // Calculadora ArbiPro (implementa√ß√£o da sua primeira calculadora)
      initArbiPro() {
        const $ = (sel, root = document) => root.querySelector(sel);

        function parseFlex(n) {
          if (n === null || n === undefined) return NaN;
          const s = String(n).trim();
          if (s === '') return NaN;
          const hasC = s.includes(',');
          const hasD = s.includes('.');
          let t = s;
          if (hasC && !hasD) t = s.replace(',', '.');
          else if (hasC && hasD) t = s.replace(/\./g, '').replace(',', '.');
          const v = parseFloat(t);
          return Number.isFinite(v) ? v : NaN;
        }

        const toFixed2 = (n) => (Number.isFinite(n) ? n.toFixed(2) : "0.00");
        const fmtBRL = (n) => (Number.isFinite(n) ? n : 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
        const fmtDec = (n) => Number.isFinite(n) ? n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : "";
        const keepNumeric = (s) => s.replace(/[^0-9.,]/g, "");

        const MAX_HOUSES = 6;
        let numHouses = 2;
        let roundingValue = 0.01;
        let displayRounding = "0.01";
        let manualOverrides = {};

        let houses = Array.from({ length: MAX_HOUSES }).map((_, index) => ({
          odd: "", increase: null, finalOdd: 0, stake: "0", commission: null, freebet: false, fixedStake: index === 0, lay: false, responsibility: ""
        }));

        let results = { profits: [], totalStake: 0, roi: 0 };

        function roundStake(value) {
          const num = parseFlex(value);
          if (!Number.isFinite(num)) return value;
          const rounded = Math.round(num / roundingValue) * roundingValue;
          return fmtDec(rounded);
        }

        function smartRoundStake(value, targetProfit, odd, commission = 0) {
          const num = parseFlex(value);
          if (!Number.isFinite(num)) return fmtDec(num);
          
          const step = roundingValue;
          const baseRounded = Math.round(num / step) * step;
          
          const options = [
            Math.max(0, baseRounded - step),
            baseRounded,
            baseRounded + step
          ];
          
          let bestOption = baseRounded;
          let bestScore = -Infinity;
          
          options.forEach(option => {
            if (option <= 0) return;
            
            const effOdd = odd * (1 - commission / 100);
            const profit = option * effOdd - targetProfit;
            
            let score = profit;
            if (profit > 0) score += 100;
            score -= Math.abs(option - num) * 10;
            
            if (score > bestScore) {
              bestScore = score;
              bestOption = option;
            }
          });
          
          return fmtDec(bestOption);
        }

        const activeHouses = () => houses.slice(0, numHouses);

        let pending = false;
        function scheduleUpdate() {
          if (pending) return;
          pending = true;
          requestAnimationFrame(() => {
            pending = false;
            recalcStakeDistribution();
            calculateResults(activeHouses());
            updateAllHouseUIs();
            updateResultsUI();
          });
        }

        function calculateResults(active) {
          let totalStake = 0;
          const profits = new Array(active.length).fill(0);
          active.forEach(h => {
            const stake = parseFlex(h.stake) || 0;
            const resp = parseFlex(h.responsibility) || 0;
            if (!h.freebet) totalStake += h.lay ? resp : stake;
          });
          active.forEach((h, idx) => {
            const stake = parseFlex(h.stake) || 0;
            const odd = h.finalOdd || 0;
            const commission = h.commission || 0;
            if (h.lay) {
              const resp = parseFlex(h.responsibility) || 0;
              profits[idx] = stake * (1 - commission / 100) - (totalStake - resp);
            } else if (h.freebet) {
              const gross = stake * odd - totalStake;
              const comm = gross > 0 ? (commission / 100) * gross : 0;
              profits[idx] = gross - comm;
            } else {
              const effOdd = odd * (1 - commission / 100);
              profits[idx] = stake * effOdd - totalStake;
            }
          });
          const minProfit = profits.length ? Math.min(...profits) : 0;
          const denom = active.some(h => h.freebet)
            ? active.reduce((s, h) => s + (h.freebet ? (parseFlex(h.stake) || 0) : 0), 0) || 1
            : (active.reduce((s, h) => s + (h.freebet ? 0 : (h.lay ? (parseFlex(h.responsibility) || 0) : (parseFlex(h.stake) || 0))), 0) || 1);
          const roi = (minProfit / denom) * 100;
          results = { profits, totalStake, roi };
        }

        function recalcStakeDistribution() {
          const active = activeHouses();
          const fixedIndex = active.findIndex(h => h.fixedStake);
          if (fixedIndex === -1) return;
          const fixed = active[fixedIndex];
          const fixedStake = parseFlex(fixed.stake) || 0;
          const fixedOdd = fixed.finalOdd;
          if (!(fixedStake > 0 && fixedOdd > 0)) return;

          let changed = false;
          const newHouses = [...houses];

          active.forEach((h, idx) => {
            const overrides = manualOverrides[idx] || {};
            const oddVal = parseFlex(h.odd) || 0;
            const stakeVal = parseFlex(h.stake) || 0;
            if (h.lay && !overrides.responsibility && oddVal > 1 && stakeVal > 0) {
              const responsibility = stakeVal * (oddVal - 1);
              const current = parseFlex(h.responsibility) || 0;
              if (Math.abs(current - responsibility) > 1e-6) {
                changed = true;
                newHouses[idx] = { ...newHouses[idx], responsibility: fmtDec(responsibility) };
              }
            }
            if (idx !== fixedIndex && h.finalOdd > 0 && !overrides.stake) {
              const fixedCommission = fixed.commission || 0;
              const houseCommission = h.commission || 0;
              const fixedProfit = fixedStake * fixedOdd * (1 - fixedCommission / 100);
              let calcStake;
              if (h.lay) {
                calcStake = fixedProfit / (h.finalOdd - houseCommission / 100);
              } else {
                const eff = h.finalOdd * (1 - houseCommission / 100);
                calcStake = fixedProfit / eff;
              }
              
              let finalStakeStr;
              if (h.lay) {
                finalStakeStr = fmtDec(calcStake);
              } else {
                finalStakeStr = smartRoundStake(calcStake, fixedProfit, h.finalOdd, houseCommission);
              }
              
              const finalStakeNum = parseFlex(finalStakeStr) || 0;
              const cur = parseFlex(h.stake) || 0;
              if (Math.abs(cur - finalStakeNum) > 1e-6) {
                changed = true;
                if (h.lay) {
                  const resp = finalStakeNum * Math.max(oddVal - 1, 0);
                  newHouses[idx] = { ...newHouses[idx], stake: finalStakeStr, responsibility: fmtDec(resp), fixedStake: false };
                } else {
                  newHouses[idx] = { ...newHouses[idx], stake: finalStakeStr, fixedStake: false };
                }
              }
            }
          });

          if (changed) { houses = newHouses; updateAllHouseUIs(); }
        }

        function cardHTML(idx, h) {
          const oddDisplay = toFixed2(h.finalOdd || 0).replace('.', ',');
          return `
            <div id="card-${idx}" class="house-card">
              <h3 class="house-title">Casa ${idx + 1}</h3>
              <div class="grid-2" style="margin-bottom: 0.75rem;">
                <div class="form-group">
                  <label class="form-label" for="odd-${idx}">Odd</label>
                  <input id="odd-${idx}" data-action="odd" data-idx="${idx}" type="text" inputmode="decimal" value="${h.odd}"
                    class="form-input" />
                </div>
                <div class="form-group">
                  <label class="form-label">Odd Final</label>
                  <div id="finalOdd-${idx}" class="form-input" style="display: flex; align-items: center; background: rgba(17, 24, 39, 0.4); font-family: ui-monospace, monospace;">${oddDisplay}</div>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label" for="stake-${idx}">Stake</label>
                <div style="display: flex; gap: 0.5rem;">
                  <div style="position: relative; flex: 1;">
                    <span style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-weight: 600; font-size: 0.75rem;">R$</span>
                    <input id="stake-${idx}" data-action="stake" data-idx="${idx}" type="text" inputmode="decimal" value="${h.stake || ''}"
                      class="form-input" style="padding-left: 2.25rem; font-family: ui-monospace, monospace;" />
                  </div>
                  <button data-action="toggleLay" data-idx="${idx}" class="btn-toggle ${h.lay ? 'active' : ''}">${h.lay ? 'LAY' : 'BACK'}</button>
                </div>
              </div>

              <div style="display: flex; gap: 0.75rem; margin: 0.75rem 0; flex-wrap: wrap;">
                <label class="checkbox-group">
                  <input type="checkbox" ${h.commission !== null ? 'checked' : ''} data-action="toggleCommission" data-idx="${idx}" />
                  <span>Comiss√£o</span>
                </label>
                <label class="checkbox-group">
                  <input type="checkbox" ${h.freebet ? 'checked' : ''} data-action="toggleFreebet" data-idx="${idx}" />
                  <span>Freebet</span>
                </label>
                <label class="checkbox-group">
                  <input type="checkbox" ${h.increase !== null ? 'checked' : ''} data-action="toggleIncrease" data-idx="${idx}" />
                  <span>Aumento de Odd</span>
                </label>
              </div>

              ${h.commission !== null ? `
              <div class="form-group">
                <label class="form-label" for="commission-${idx}">Comiss√£o (%)</label>
                <div style="position: relative;">
                  <input id="commission-${idx}" data-action="commissionValue" data-idx="${idx}" type="text" inputmode="decimal" value="${h.commission === 0 ? '' : (h.commission ?? '')}"
                    class="form-input" style="padding-right: 2.25rem;" />
                  <span style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-weight: 600;">%</span>
                </div>
              </div>` : ''}

              ${h.increase !== null ? `
              <div class="form-group">
                <label class="form-label" for="increase-${idx}">Aumento de Odd (%)</label>
                <div style="position: relative;">
                  <input id="increase-${idx}" data-action="increaseValue" data-idx="${idx}" type="text" inputmode="decimal" value="${h.increase === 0 ? '' : (h.increase ?? '')}"
                    class="form-input" style="padding-right: 2.25rem;" />
                  <span style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-weight: 600;">%</span>
                </div>
              </div>` : ''}

              ${h.lay ? `
              <div class="form-group">
                <label class="form-label" for="responsibility-${idx}">Responsabilidade</label>
                <div style="position: relative;">
                  <span style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-weight: 600; font-size: 0.75rem;">R$</span>
                  <input id="responsibility-${idx}" data-action="responsibility" data-idx="${idx}" type="text" inputmode="decimal" value="${h.responsibility || ''}"
                    class="form-input" style="padding-left: 2.25rem; font-family: ui-monospace, monospace;" />
                </div>
              </div>` : ''}

              <button data-action="fixStake" data-idx="${idx}" class="${h.fixedStake ? 'btn btn-primary' : 'btn btn-secondary'}" style="width: 100%;">
                ${h.fixedStake ? 'Stake Fixada' : 'Fixar Stake'}
              </button>
            </div>
          `;
        }

        function housesInnerHTML() { return activeHouses().map((h, idx) => cardHTML(idx, h)).join(""); }

        function updateResultsUI() {
          $("#totalStake").textContent = fmtBRL(results.totalStake);
          const roiEl = $("#roi");
          roiEl.textContent = (results.roi >= 0 ? "+" : "") + results.roi.toFixed(2) + "%";
          roiEl.className = "stat-value " + (results.roi >= 0 ? "profit-highlight" : "profit-negative");

          const active = activeHouses();
          const anyLay = active.some(h => h.lay);
          const anyIncrease = active.some(h => h.increase !== null);

          const headerHTML = `
            <tr>
              <th>Casa</th>
              <th>Odd</th>
              ${anyIncrease ? '<th>Odd Aumento</th>' : ''}
              <th>Comiss√£o</th>
              <th>Stake</th>
              ${anyLay ? '<th>Responsabilidade</th>' : ''}
              <th>Lucro</th>
            </tr>
          `;
          document.querySelector('.results-table thead').innerHTML = headerHTML;

          const rowsHTML = active.map((h, idx) => {
            const oddOriginal = parseFlex(h.odd) || 0;
            const oddText = toFixed2(oddOriginal).replace('.', ',');
            const oddAumento = h.increase !== null ? toFixed2(oddOriginal).replace('.', ',') + ' ‚Üí ' + toFixed2(h.finalOdd || 0).replace('.', ',') : '';
            const commissionText = (h.commission === null)
              ? '‚Äî'
              : ((Number.isFinite(h.commission) ? h.commission : 0).toLocaleString('pt-BR', { maximumFractionDigits: 2 }) + '%');
            const stakeText = h.stake ? h.stake : "0,00";
            const profit = results.profits[idx] || 0;
            const profitClass = profit >= 0 ? 'profit-positive' : 'profit-negative';
            const profitValue = fmtBRL(profit);
            return `
              <tr>
                <td><strong>Casa ${idx + 1}</strong></td>
                <td>${oddText}</td>
                ${anyIncrease ? `<td>${h.increase !== null ? oddAumento : '‚Äî'}</td>` : ''}
                <td>${commissionText}</td>
                <td><strong>R$ ${stakeText}</strong>${h.freebet ? '<br><span class="text-small">(Freebet)</span>' : ''}</td>
                ${anyLay ? `<td>${h.lay ? fmtBRL(parseFlex(h.responsibility) || 0) : '‚Äî'}</td>` : ''}
                <td class="${profitClass}"><strong>${profitValue}</strong></td>
              </tr>
            `;
          }).join("");

          document.getElementById("resultsRows").innerHTML = rowsHTML;
        }

        function updateCardComputed(idx) {
          const h = houses[idx];
          const oddEl = document.getElementById(`finalOdd-${idx}`);
          if (oddEl) oddEl.textContent = toFixed2(h.finalOdd || 0).replace('.', ',');
          if (h.lay && !(manualOverrides[idx] && manualOverrides[idx].responsibility)) {
            const rEl = document.getElementById(`responsibility-${idx}`);
            if (rEl) rEl.value = h.responsibility || "";
          }
          if (!(manualOverrides[idx] && manualOverrides[idx].stake)) {
            const sEl = document.getElementById(`stake-${idx}`);
            if (sEl) sEl.value = h.stake || "";
          }
        }

        function updateAllHouseUIs() { activeHouses().forEach((_, i) => updateCardComputed(i)); }

        function initialRender() {
          const app = $("#app");
          app.innerHTML = `
            <div style="text-align: center; margin-bottom: 1.5rem;">
              <h1 style="font-size: 1.75rem; font-weight: 800; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem;">Calculadora ArbiPro</h1>
              <p style="color: var(--text-secondary); font-size: 0.875rem;">Calcule stakes otimizados para garantir lucro em qualquer resultado</p>
            </div>

            <div class="stats-grid">
              <div class="card">
                <div class="section-title" style="font-size: 0.875rem; margin-bottom: 0.75rem;">Configura√ß√µes</div>
                <div class="form-group">
                  <label class="form-label">N√∫mero de Casas:</label>
                  <select id="numHouses" class="form-select">
                    <option value="2" ${numHouses===2?'selected':''}>2 Casas</option>
                    <option value="3" ${numHouses===3?'selected':''}>3 Casas</option>
                    <option value="4" ${numHouses===4?'selected':''}>4 Casas</option>
                    <option value="5" ${numHouses===5?'selected':''}>5 Casas</option>
                    <option value="6" ${numHouses===6?'selected':''}>6 Casas</option>
                  </select>
                </div>
              </div>

              <div class="card">
                <div class="section-title" style="font-size: 0.875rem; margin-bottom: 0.75rem;">Arredondamento</div>
                <div class="form-group">
                  <label class="form-label">Stakes Para:</label>
                  <select id="rounding" class="form-select">
                    <option value="0.01" ${displayRounding==="0.01"?'selected':''}>R$ 0,01</option>
                    <option value="0.10" ${displayRounding==="0.10"?'selected':''}>R$ 0,10</option>
                    <option value="0.50" ${displayRounding==="0.50"?'selected':''}>R$ 0,50</option>
                    <option value="1.00" ${displayRounding==="1.00"?'selected':''}>R$ 1,00</option>
                  </select>
                </div>
              </div>

              <div class="stat-card">
                <div class="stat-value" id="totalStake">R$ 0,00</div>
                <div class="stat-label">Total Investido</div>
              </div>

              <div class="stat-card">
                <div class="stat-value profit-highlight" id="roi">0,00%</div>
                <div class="stat-label">ROI M√©dio</div>
              </div>
            </div>

            <div class="card">
              <div class="section-title">Casas de Apostas</div>
              <div id="houses" class="house-grid"></div>
            </div>

            <div class="card" style="margin-top: 1.5rem;">
              <div class="section-title">Resultados ArbiPro</div>
              <div style="overflow-x: auto;">
                <table class="results-table">
                  <thead>
                    <tr>
                      <th>Casa</th>
                      <th>Odd Final</th>
                      <th>Comiss√£o</th>
                      <th>Stake</th>
                      <th>Lucro</th>
                    </tr>
                  </thead>
                  <tbody id="resultsRows"></tbody>
                </table>
              </div>
            </div>
          `;

          document.getElementById("houses").innerHTML = housesInnerHTML();

          // Event Listeners
          document.getElementById("numHouses").addEventListener("change", (e) => {
            numHouses = parseInt(e.target.value, 10);
            document.getElementById("houses").innerHTML = housesInnerHTML();
            scheduleUpdate();
          });

          document.getElementById("rounding").addEventListener("change", (e) => {
            displayRounding = e.target.value;
            roundingValue = parseFloat(displayRounding.replace(',', '.'));
            scheduleUpdate();
          });

          const container = document.getElementById("houses");

          container.addEventListener("input", (e) => {
            const t = e.target;
            if (t.getAttribute && t.getAttribute("inputmode") === "decimal") {
              const caret = t.selectionStart;
              const before = t.value;
              t.value = keepNumeric(before);
              try { t.setSelectionRange(caret, caret); } catch {}
            }
            if (!t.getAttribute) return;
            const action = t.getAttribute("data-action");
            if (!action) return;
            const idx = parseInt(t.getAttribute("data-idx") || "-1", 10);
            if (idx < 0) return;

            if (action === "odd") setHouse(idx, { odd: t.value });
            else if (action === "stake") setHouse(idx, { stake: t.value }, ["stake"]);
            else if (action === "responsibility") setHouse(idx, { responsibility: t.value }, ["responsibility"]);
            else if (action === "commissionValue") {
              const val = parseFlex(t.value);
              if (Number.isFinite(val)) setHouse(idx, { commission: val });
              else if (t.value === "") setHouse(idx, { commission: 0 });
            }
            else if (action === "increaseValue") {
              const val = parseFlex(t.value);
              if (Number.isFinite(val)) setHouse(idx, { increase: val });
              else if (t.value === "") setHouse(idx, { increase: 0 });
            }
            scheduleUpdate();
          });

          container.addEventListener("blur", (e) => {
            const el = e.target;
            if (el.getAttribute && el.getAttribute("inputmode") === "decimal") {
              const v = parseFlex(el.value);
              if (Number.isFinite(v)) el.value = fmtDec(v);
            }
            scheduleUpdate();
          }, true);

         // Procure o event listener de "change" na calculadora ArbiPro e substitua por:

     container.addEventListener("change", (e) => {
            const el = e.target;
            if (!el.getAttribute) return;
            const action = el.getAttribute("data-action");
            if (!action) return;
            const idx = parseInt(el.getAttribute("data-idx") || "-1", 10);
            if (idx < 0) return;
            if (action === "toggleCommission") {
              const newVal = el.checked ? 0 : null;
              setHouse(idx, { commission: newVal });
              const card = document.getElementById(`card-${idx}`);
              if (card) card.outerHTML = cardHTML(idx, houses[idx]);
              scheduleUpdate();
            } else if (action === "toggleFreebet") {
              setHouse(idx, { freebet: el.checked });
              scheduleUpdate();
            } else if (action === "toggleIncrease") {
              const newVal = el.checked ? 0 : null;
              setHouse(idx, { increase: newVal });
              const card = document.getElementById(`card-${idx}`);
              if (card) card.outerHTML = cardHTML(idx, houses[idx]);
              scheduleUpdate();
            }
          });

          container.addEventListener("click", (e) => {
            // Primeiro verifica se √© diretamente o elemento com data-action
            let el = e.target;
            if (el.getAttribute && el.getAttribute("data-action")) {
              // √â o pr√≥prio elemento
            } else if (el.closest) {
              // Procura no elemento pai mais pr√≥ximo
              el = el.closest("[data-action]");
            }
            
            if (!el || !el.getAttribute) return;
            
            const action = el.getAttribute("data-action");
            const idx = parseInt(el.getAttribute("data-idx") || "-1", 10);
            if (idx < 0) return;

            e.preventDefault(); // Previne comportamento padr√£o
            e.stopPropagation(); // Para a propaga√ß√£o do evento

            if (action === "toggleLay") {
              setHouse(idx, { lay: !houses[idx].lay });
              const card = document.getElementById(`card-${idx}`);
              if (card) card.outerHTML = cardHTML(idx, houses[idx]);
              scheduleUpdate();
            } else if (action === "fixStake") {
              // Remove fixa√ß√£o de todas as outras casas e alterna a atual
              houses = houses.map((h, i) => ({ 
                ...h, 
                fixedStake: i === idx ? !h.fixedStake : false 
              }));
              
              // Atualiza a UI de todas as casas para refletir as mudan√ßas
              document.getElementById("houses").innerHTML = housesInnerHTML();
              scheduleUpdate();
            }
          });

          scheduleUpdate();
        }

        function setHouse(idx, patch, setOverrideKeys = []) {
          const prev = houses[idx];
          const h = { ...prev, ...patch };

          const oddVal = parseFlex(h.odd) || 0;
          const incVal = parseFlex(h.increase) || 0;
          
          let calculatedOdd = oddVal;
          if (h.increase !== null && incVal > 0 && oddVal > 1) {
            calculatedOdd = oddVal + (oddVal - 1) * (incVal / 100);
          }
          
          h.finalOdd = h.freebet ? Math.max(calculatedOdd - 1, 0) : calculatedOdd;

          if (h.lay && !(manualOverrides[idx] && manualOverrides[idx].responsibility)) {
            const stakeVal = parseFlex(h.stake) || 0;
            if (stakeVal > 0 && oddVal > 1) h.responsibility = fmtDec(stakeVal * (oddVal - 1));
            else if (!h.responsibility) h.responsibility = "";
          }

          houses[idx] = h;

          if (setOverrideKeys.length) {
            manualOverrides[idx] = manualOverrides[idx] || {};
            setOverrideKeys.forEach(k => manualOverrides[idx][k] = true);
          }

          const oddEl = document.getElementById(`finalOdd-${idx}`);
          if (oddEl) oddEl.textContent = toFixed2(h.finalOdd || 0).replace('.', ',');
        }

        initialRender();
      }
    };

    // Inicializar quando DOM estiver pronto
    document.addEventListener('DOMContentLoaded', () => {
      FreePro.init();
    });

    // Debug global
    window.FreePro = FreePro;
  </script>

</body>
</html>
